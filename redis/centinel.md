# 고가용성 기능 필요성
- 레디스는 따로 백업 설정을 하지 않았을 때 레디스 인스턴스가 재시작된다면 레디스에 있는 모든 데이터는 유실
- 복제본을 구성했다면 마스터에 장애가 발생한 경우에도 데이터는 복제본 노드에 남아있을 수 있음
- 클라이언트가 직접 마스터에 연결된 상태였다면 아래와 같은 과정을 거쳐야 장애 상황을 복구할 수 있다.
  1. 복제본 노드에 직접 접속한 뒤 REPLICA OF NO ONE 커맨드를 입력해 읽기 전용 상태 해제
  2. 애플리케이션 코드에서 레디스 앤드포인트를 복제본 IP로 변경
  3. 배포
- 별도의 고가용성 기능 없이 마스터 노드에 장애가 발생했다면, 장애 처리가 지연되어 서비스 문제로 이어질 수 있다.
- 또한 캐시가 look aside 구성인 경우 애플리케이션이 캐시에 접근할 수 없을 때 직접 MySQL과 같은 원본 데이터 소스에서 데이터를 읽어오려고 하기 때문에 서버 부하가 급증한다. 

# 센티널
- 센티널은 기존 레디스 인스턴스와는 다른 역할, 마스터 인스턴스에 장애가 발생하면 레디스를 계속 사용할 수 있도록 동작 (자동 페일오버)
## 센티널 기능
- 모니터링: 마스터, 복제본 인스턴스 상태를 실시간으로 확인
- 자동 페일오버: 마스터 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격. 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결
- 인스턴스 구성 정보 안내: 클라이언트에게 현재 구성에서의 마스터 정보 알려줌. 페일오버가 발생하면 변경된 마스터 정보를 재전달하기에 페일 오버가 발생하더라도 레디스의 엔드포인트 정보를 변경할 필요가 없음

## 분산 시스템으로 동작하는 센티널
- SPOF(Single Point Of Failure): 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점
- 센티널은 SPOF가 되는 것을 방지하기 위해 최소 3대 이상 정상적으로 동작할 수 있도록 설계
- 쿼럼(quorum)은 마스터가 비정상 동작을 한다는 것에 동의해야 한다는 센티널의 수로, 쿼럼을 만족하는 경우 페일 오버를 시작. 과반수 선출 개념을 사용하기에 ㄱ대 이상의 홀수로 구성하는 것이 권장

## 센티널 인스턴스 배치 방법
- 센티널 인스턴스는 물리적으로 서로 영향받지 않는 서버에서 실행
- 보통 하나의 서버에 레디스 프로세스와 센티널 프로세스를 동시에 실행
- 페일오버가 발생하면 기존 마스터를 바라보고 있던 클라이언트는 모두 서버 B에서 새롭게 선출된 마스터로 연결, 레디스로 새롭게 들어오는 커넥션은 모두 마스터 IP 정보로 서버 B의 레디스 주소 받음
- 이와 같은 상황에서 A가 복구된다면, 기존 마스터 서버였던 A를 서버 B의 복제본이 되도록 자동으로 연결

# 센티널 인스턴스 실행
- 센티널 프로세스 실행하기 전 마스터와 복제본 노드 간 복제 연결이 된 상태로 만듬. 복제본 노드에서 복제 연결 시작하는 커맨드 입력
```redis
REPLICAOF 192.168.0.11 6379
```
- 센티널 프로세스를 띄우기 위해선 sentinel.conf 라는 별도의 구성 파일이 필요
```redis
port 26379
sentinel monitor master-test 192.168.0.11 6379 2
```
- port는 센티널 프로세스가 실행될 포트
- sentinel monitor는 모니터링할 마스터의 이름을 지정하고, 마스터에 이름을 부여하며, 쿼럼 값을 지정
- 센티널은 마스터와 복제본을 포함하는 모든 레디스 프로세스를 모니터링하지만, 구성 파일에는 복제본 정보를 직접 입력하지 않아도 됨. 센티널 프로세스가 시작하면 마스터에 연결된 복제본을 자동으로 찾아내는 과정을 거치기 때문

## 센티널 프로세스 실행
- 센티널을 실행시키는 방법
```redis
# redis-sentinel 이용
redis-sentinel /path/to/sentinel.conf

# redis-server 이용
redis-server /path/to/sentinel.conf --sentinel
```
- 모두 명시된 sentienl.conf 파일을 이용해 센티널 인스턴스를 시작
```redis
redis-cli -p 26379
```
- 위의 커맨드로 센티널 인스턴스에 직접 접근
- 아래 커맨드로 센티널의 접속 후 센티널이 모니터링하고 있는 마스터와 복제본 노드 정보 그리고 복제본을 함께 모니터링하고 있는 다른 센티널 인스턴스에 대한 정보를 확인할 수 있음
```redis
SENTINEL master <master-name> # 마스터의 IP, 포트, 연결된 복제본 수 등 다양한 정보 확인
```
- `num-other-sentinels` 값은 마스터를 모니터링하고 있는 다른 센티널의 정보
- `flags`는 마스터의 상태. 정상적이지 않다면 s_down, o_down 등의 값
- `num-slaves` 값은 현재 마스터에 연결된 복제본의 개수
```redis
SENTINEL replicas # 마스터에 연결된 복제본의 자세한 정보를 확인
SENTINEL sentinels # 마스터를 모니터링하고 있는 다른 Sentinel 인스턴스의 정보를 확인
SENTINEL ckquorum # 마스터를 바라보고 있는 센티널 인스턴스가 설정한 쿼럼 값보다 큰지 확인
```

## 페일오버 테스트
# 센티널 운영
## 패스워드 인증
## 복제본 우선순위
## 운영 중 센ㅇ티널 구성 정보 변경
## 센티널 초기화
## 센티널 노드의 추가/제거
## 센티널 자동 페일오버 과정
## 스플릿 브레인 현상