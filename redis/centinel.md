- [고가용성 기능 필요성](#고가용성-기능-필요성)
- [센티널](#센티널)
  - [센티널 기능](#센티널-기능)
  - [분산 시스템으로 동작하는 센티널](#분산-시스템으로-동작하는-센티널)
  - [센티널 인스턴스 배치 방법](#센티널-인스턴스-배치-방법)
- [센티널 인스턴스 실행](#센티널-인스턴스-실행)
  - [센티널 프로세스 실행](#센티널-프로세스-실행)
  - [페일오버 테스트](#페일오버-테스트)
    - [1. 커맨드를 이용한 페일오버 발생(수동 페일오버)](#1-커맨드를-이용한-페일오버-발생수동-페일오버)
    - [2. 마스터 동작을 중지시키는 페일오버 발생(자동 페일오버)](#2-마스터-동작을-중지시키는-페일오버-발생자동-페일오버)
- [센티널 운영](#센티널-운영)
  - [패스워드 인증](#패스워드-인증)
  - [복제본 우선순위](#복제본-우선순위)
  - [운영 중 센티널 구성 정보 변경](#운영-중-센티널-구성-정보-변경)
  - [센티널 초기화](#센티널-초기화)
  - [센티널 노드의 추가/제거](#센티널-노드의-추가제거)
  - [센티널 자동 페일오버 과정](#센티널-자동-페일오버-과정)
    - [1. 마스터 장애 상황 감지](#1-마스터-장애-상황-감지)
    - [2. 에포크 증가](#2-에포크-증가)
    - [3. 센티널 리더 선출](#3-센티널-리더-선출)
    - [4. 복제본 선정 후 마스터로 승격](#4-복제본-선정-후-마스터로-승격)
    - [5. 복제 연결 변경](#5-복제-연결-변경)
  - [스플릿 브레인 현상](#스플릿-브레인-현상)

# 고가용성 기능 필요성
- 레디스는 따로 백업 설정을 하지 않았을 때 레디스 인스턴스가 재시작된다면 레디스에 있는 모든 데이터는 유실
- 복제본을 구성했다면 마스터에 장애가 발생한 경우에도 데이터는 복제본 노드에 남아있을 수 있음
- 클라이언트가 직접 마스터에 연결된 상태였다면 아래와 같은 과정을 거쳐야 장애 상황을 복구할 수 있다.
  1. 복제본 노드에 직접 접속한 뒤 REPLICA OF NO ONE 커맨드를 입력해 읽기 전용 상태 해제
  2. 애플리케이션 코드에서 레디스 앤드포인트를 복제본 IP로 변경
  3. 배포
- 별도의 고가용성 기능 없이 마스터 노드에 장애가 발생했다면, 장애 처리가 지연되어 서비스 문제로 이어질 수 있다.
- 또한 캐시가 look aside 구성인 경우 애플리케이션이 캐시에 접근할 수 없을 때 직접 MySQL과 같은 원본 데이터 소스에서 데이터를 읽어오려고 하기 때문에 서버 부하가 급증한다. 

# 센티널
- 센티널은 기존 레디스 인스턴스와는 다른 역할, 마스터 인스턴스에 장애가 발생하면 레디스를 계속 사용할 수 있도록 동작 (자동 페일오버)
## 센티널 기능
- 모니터링: 마스터, 복제본 인스턴스 상태를 실시간으로 확인
- 자동 페일오버: 마스터 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격. 기존 마스터에 연결된 복제본은 새롭게 승격된 마스터에 연결
- 인스턴스 구성 정보 안내: 클라이언트에게 현재 구성에서의 마스터 정보 알려줌. 페일오버가 발생하면 변경된 마스터 정보를 재전달하기에 페일 오버가 발생하더라도 레디스의 엔드포인트 정보를 변경할 필요가 없음

## 분산 시스템으로 동작하는 센티널
- SPOF(Single Point Of Failure): 하나의 서비스에 문제가 발생했을 때 전체 시스템이 영향을 받는 지점
- 센티널은 SPOF가 되는 것을 방지하기 위해 최소 3대 이상 정상적으로 동작할 수 있도록 설계
- 쿼럼(quorum)은 마스터가 비정상 동작을 한다는 것에 동의해야 한다는 센티널의 수로, 쿼럼을 만족하는 경우 페일 오버를 시작. 과반수 선출 개념을 사용하기에 ㄱ대 이상의 홀수로 구성하는 것이 권장

## 센티널 인스턴스 배치 방법
- 센티널 인스턴스는 물리적으로 서로 영향받지 않는 서버에서 실행
- 보통 하나의 서버에 레디스 프로세스와 센티널 프로세스를 동시에 실행
- 페일오버가 발생하면 기존 마스터를 바라보고 있던 클라이언트는 모두 서버 B에서 새롭게 선출된 마스터로 연결, 레디스로 새롭게 들어오는 커넥션은 모두 마스터 IP 정보로 서버 B의 레디스 주소 받음
- 이와 같은 상황에서 A가 복구된다면, 기존 마스터 서버였던 A를 서버 B의 복제본이 되도록 자동으로 연결

# 센티널 인스턴스 실행
- 센티널 프로세스 실행하기 전 마스터와 복제본 노드 간 복제 연결이 된 상태로 만듬. 복제본 노드에서 복제 연결 시작하는 커맨드 입력
```redis
REPLICAOF 192.168.0.11 6379
```
- 센티널 프로세스를 띄우기 위해선 sentinel.conf 라는 별도의 구성 파일이 필요
```redis
port 26379
sentinel monitor master-test 192.168.0.11 6379 2
```
- port는 센티널 프로세스가 실행될 포트
- sentinel monitor는 모니터링할 마스터의 이름을 지정하고, 마스터에 이름을 부여하며, 쿼럼 값을 지정
- 센티널은 마스터와 복제본을 포함하는 모든 레디스 프로세스를 모니터링하지만, 구성 파일에는 복제본 정보를 직접 입력하지 않아도 됨. 센티널 프로세스가 시작하면 마스터에 연결된 복제본을 자동으로 찾아내는 과정을 거치기 때문

## 센티널 프로세스 실행
- 센티널을 실행시키는 방법
```redis
# redis-sentinel 이용
redis-sentinel /path/to/sentinel.conf

# redis-server 이용
redis-server /path/to/sentinel.conf --sentinel
```
- 모두 명시된 sentienl.conf 파일을 이용해 센티널 인스턴스를 시작
```redis
redis-cli -p 26379
```
- 위의 커맨드로 센티널 인스턴스에 직접 접근
- 아래 커맨드로 센티널의 접속 후 센티널이 모니터링하고 있는 마스터와 복제본 노드 정보 그리고 복제본을 함께 모니터링하고 있는 다른 센티널 인스턴스에 대한 정보를 확인할 수 있음
```redis
SENTINEL master <master-name> # 마스터의 IP, 포트, 연결된 복제본 수 등 다양한 정보 확인
```
- `num-other-sentinels` 값은 마스터를 모니터링하고 있는 다른 센티널의 정보
- `flags`는 마스터의 상태. 정상적이지 않다면 s_down, o_down 등의 값
- `num-slaves` 값은 현재 마스터에 연결된 복제본의 개수
```redis
SENTINEL replicas # 마스터에 연결된 복제본의 자세한 정보를 확인
SENTINEL sentinels # 마스터를 모니터링하고 있는 다른 Sentinel 인스턴스의 정보를 확인
SENTINEL ckquorum # 마스터를 바라보고 있는 센티널 인스턴스가 설정한 쿼럼 값보다 큰지 확인
```

## 페일오버 테스트
### 1. 커맨드를 이용한 페일오버 발생(수동 페일오버)
```redis
SENTINEL FAILOVER <master name>
```
- 센티널에 직접 접속한 뒤 이 커맨드를 사용하면 다른 센티널의 동의를 구하지 않고도 페일오버를 바로 발생시킬 수 있음

### 2. 마스터 동작을 중지시키는 페일오버 발생(자동 페일오버)
- 직접 마스터 노드에 장애를 발생시킨 뒤 페일오버가 잘 발생하는지 확인하여 마스터가 정상이 아닐 때 센티널이 이를 인지하는지 확인
```redis
redis-cli -h <master-host> -p <master-port> shutdown
```
- 센티널은 주기적으로 마스터 노드에 PING을 보내 응답이 정상적으로 돌아오는지 확인함으로써 마스터의 상태를 파악 (sentinal.conf에 지정한 down-after-miliseconds, 기본값 30초)

# 센티널 운영
## 패스워드 인증
- 복제본 노드에 requirepass/masterauth 옵션을 이용해 패스워드를 설정한 경우 센티널의 설정 파일에서도 패스워드를 지정
- 복제된 노드가 모두 마스터가 될 가능성이 있기에 하나의 복제 그룹에서 requirepass와 masterauth 값은 모든 노드에서 동일하게 설정
```redis
sentinel auth-pass <master-name> <password>
```

## 복제본 우선순위
- 모든 레디스 인스턴스는 replica-priority 파라미터 가짐
- 페일오버를 진행할 때 복제본 노드의 replica-priority라는 우선순위 노드를 확인하며, 해당 값이 가장 작은 노드륾 마스터로 선출
- 기본값 100, 이 값이 0인 복제본은 절대로 마스터로 선출되지 않음

## 운영 중 센티널 구성 정보 변경
- 센티널 실행 도중 모니터링할 마스터를 추가, 제거, 변경 가능
- 마스터를 모니터링하는 센티널이 여러 대라면 각각의 센티널에 모두 설정을 적용. 설정을 변경했다고 해서 그 정보들이 다른 센티널로 전파되지 않음
```redis
SENTINEL MONITOR <master name> <ip> <port> <quorum> // 센티널이 새로운 마스터를 모니터링

SENTINEL REMOVE <master name> // 더 이상 지정하는 마스터를 모니터링 하지 않음

SENTINAL SET <name> [<option> <value> ...] // 특정 마스터에 대한 지정한 파라미터를 변경

SENTINEL CONFIG SET <configuration name> <value> // 레디스 6.2 이상부터 센티널 고유한 설정값 런타임 중에 변경
```
  
## 센티널 초기화
- 센티널은 비정상이라고 판단한 복제본 노드에 대해서도 임의로 모니터링을 멈추지 않음
```redis
SENTINEL RESET <master name> // 서버를 더 이상 사용할 수 없어 해당 인스턴스에 대한 모니터링 중단
```
- 마스터 이름 대신 *을 입력해 센티널이 모니터링하고 있는 전체 마스터 정보를 초기화할 수도 있음

## 센티널 노드의 추가/제거
- 새로운 센티널 추가: 마스터를 모니터링 하도록 설정한 센티널 인스턴스를 실행시키면 자동으로 기존에 실행 중이던 다른 센티널의 known-list에 추가
- 한 번에 여러 대의 센티널을 추가해야 하는 경우 10초 이상의 간격을 두면서 1개씩 목록에 들어가도록 천천히 추가하는 것이 오류 발생 가능성을 줄이는 방법
- 모든 센티널 추가가 완료되었다면 `SENETINEL MASTER <mastername> 커맨드의 num-other-sentinels` 반환 값을 통해 정상적으로 추가됐는지 확인

## 센티널 자동 페일오버 과정
### 1. 마스터 장애 상황 감지
- PING에 대한 유효한 응답은 +PONG, -LOADING, -MASTERDOWN이며, 다른 응답이나 응답을 아예 받지 못할 경우는 모두 유효하지 않다고 판단
- 마스터의 상태를 sdown으로 플래깅 (subjectly down: 주관적인 다운 상태) 이후 해당 노드는 다른 센티널 노드에게 `SENTINEL is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*>` 커맨드를 사용해 다른 센티널에게 장애 사실 전파
- 쿼럼 값 이상의 센티널 노드에서 마스터 장애를 인지했다면 마스터의 상태를 odown으로 변경(object down: 객관적인 다운 상태)
- 센티널은 모든 레디스 노드를 모니터ㅎ. 복제본 노드에 장애가 발생하는 경우 해당 복제본 노드를 sdown. 그러나 이를 전파하지는 않음 (단, sdown 복제본 노드는 마스터 노드 승격 불가)

### 2. 에포크 증가
- 처음으로 마스터 노드를 odown으로 인지한 노드가 페일오버 과정 시작
- 센티널은 페일오버를 시작하기 전 에포크 값 하나 증가
- 에포크는 각 마스터에서 발생한 페일오버의 버전을 관리. 처음으로 페일오버가 일어났을 때 값은 1. 동일한 에포크 값으로 페일오버 과정이 진행되는 동안 모든 센티널 노드가 같은 작업을 시도한다는 것을 보장

### 3. 센티널 리더 선출
- 에포크를 증가시킨 센티널은 다른 센티널 노드에게 센티널 리더를 선출하기 위한 투표 메시지 보냄. 이때 증가시킨 에포크 값 함께 전달, 메시지를 받은 다른 센티널 노드가 현재 자신의 에포크보다 전달받은 에포크가 클 경우 자신의 에포크를 증가시킨 뒤, 센티널 리더에게 투표하겠다는 응답 보냄
- 센티널 노드가 ㅌ투표 요구를 받았을 때 함께 전달받은 에포크 값이 자신의 에포크 값과 동일하다면 이미 리더로 선출한 센티널 id값 응답. 하나의 에포크에서 센티널은 하나의 센티널에 투표할 수 있으며, 투표 결과는 변경할 수 없음

### 4. 복제본 선정 후 마스터로 승격
- 마스터로부터 오랜 기간 연결이 끊어진 복제본은 마스터 자격 없음
- 자격은 다음 순으로
  1. redis.conf 파일에 명시된 replica-priority가 낮은 복제본
  2. 마스터로부터 더 많은 데이터를 수신한 복제본(master_repl_오프셋)
  3. 2번 조건까지 동일하다면, runID가 사전 순으로 작은 복제본
- 선정한 복제본은 `slaveof no one` 커맨드로 기존 마스터로부터 복제를 끊음

### 5. 복제 연결 변경
- 기존 마스터에 연결돼 있던 다른 복제본이 새로 승격된 마스터의 복제본이 될 수 있도록 복제본마다 `replicaof new-ip new-port` 커맨드를 수행해 복제 연결 변경 
- 복제 그룹의 모든 센티널 노드에서도 레디스 구성 정보 변경

## 스플릿 브레인 현상
- 네티워크 파티션 이슈로 인해 분산 환경의 데이터 저장소가 끊어지고, 끊긴 두 부분이 각각을 정상적인 서비스라고 인식하는 현상
- 만약 마스터 노드에 장애가 발생하지 않았고, 네트워크 단절이 길어진 경우라면 하나의 복제본에 2개의 마스터가 생기는 스플릿 브레인 현상이 나타남
- 네트워크 단절이 복구된다면 기존 마스터는 센티널 B,C에 의해 새롭게 승격된 마스터의 복제본으로 연결. 복제본으로 연결되는 과정에서 복제본 노드의 데이터는 모두 삭제되기에 기존 마스터가 단절 동안 처리했던 모든 데이터가 유실
