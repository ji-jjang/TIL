# 레디스 데이터 영구 저장
- 복제는 가용성을 위한 것이며, 백업은 장애 상황에서 데이터 복구를 위해 필요하다.
- 레디스를 캐시가 아닌 영구 저장소와 같은 용도로 사용한다면 디스크에 주기적으로 백업하는 것이 안전한다. 레디스에서는 RDB, AOF 두 가지 백업 방식을 지원한다.
- AOF(Append Only File): 레디스 인스턴스가 처리한 모든 쓰기 작업을 차례대로 기록, 복원 시에는 파일을 다시 읽어가며 데이터 세트 재구성
- RDB(Redis Database): 일정 시점에 메모리에 저장된 데이터 전체를 저장(snapshot)
```redis
> SET key1 a
OK 

> SET key1 apple
OK

> SET key2 b
OK

> DEL key2
(integer) 1
```
- AOF의 경우 레디스 프로토콜 형태로 저장되며 명령어를 차례로 기록한다. RDB는 key1 -> apple 처럼 스냅샷 형태로 바이너리로 저장된다.
- RDB 파일의 경우 시점 단위로 여러 백업본을 저장할 수 있고 AOF 파일보다 복원이 빠르다. 하지만, 특정 시점으로 복구는 불가능하다. AOF는 RDB 파일보다 크기가 크고 주기적으로 압축해 작성해야 하지만, 원하는 시점으로 복구할 수 있다.
- 하나의 인스턴스에서 RDB와 AOF 두 가지 옵션을 사용하는 것도 가능하며, 데이터의 안정성을 원하는 경우 두 가지 백업 방식을 동시에 사용하는 것을 권장한다.
- 레디스에서 데이터를 복원할 수 있는 시점은 서버가 재시작될 때 뿐이며, 레디스 인스턴스의 실행 도중에 데이터 파일을 읽어올 수 있는 방법은 없다.
- 레디스 서버는 재시작될 때 AOF 파일이나 RDB 파일이 존재하는지 확인한 뒤 파일이 있을 때 파일을 로드한다. 레디스는 RDB 파일보다 AOF 파일이 더 내구성이 보장된다고 판단하기에 2개의 파일이 모두 존재할 때 AOF 데이터를 로드한다.

## RDB 방식 데이터 백업
- RDB 파일은ㄷ레디스에서 데이터를 백업하기 위한 가장 단순한 방법
- 원하는 시점에 메모리 자체를 스냅샷 찍듯 저장할 수 있기에 백업에 적합한 파일 형태
- RDB 파일이 저장될 때마다 원격 자정소로 옮겨 2차 백업을 한다면 데이터 센터 장애 등 더 큰 장애에도 대처할 수 있음
- **장애가 발생했을 때 손실 가능성을 최소화해야 하는 서비스에는 RDB 파일을 이용한 백업만 사용하는 것은 적절하지 않다. 사용자가 지정한 시간 단위로 파일이 저장되기에 저장 시점부터 장애가 발생한 직전까지의 데이터는 손실된다.**
- RDB 파일을 생성하는 방법
  - 설정 파일에서 특정 조건에 파일이 자동으로 저장되도록 지정
  - 사용자가 원하는 시점에 커맨드를 이용해 수동으로 파일 생성
  - 복제 기능을 사용한다면 레디스는 자동으로 RDB 파일 생성
### 1. 특정 조건에 자동으로 RDB 파일 생성
```redis
save <기간(초)> <기간 내 변경된 키의 개수>
dbfilename <RDB 파일 이름>
dir <RDB 파일이 저장될 경로>
```
- 레디스 설정 파일에서 save 옵션을 사용해 원하는 조건에 RDB 파일을 저장하도록 설정
- 일정한 기간 동안 변경된 키의 개수가 조건에 맞을 때 레디스 서버는 자동으로 RDB 파일을 저장
```redis
save 900 1 // 900초 동안 1개 이상의 키가 변경된 경우
save 300 10 // 300초 동안 10개 이상의 키가 변경된 경우
save 60 10000 // 60초 동안 10000개 이상의 키가 변경된 경우
```
- 만약 RDB 파일을 저장하고 싶지 않다면 `save ""`와 같이 빈 문자열로 설정해 옵션을 비활성화
- 이미 레디스가 실행 중인 상태에서는 CONFIG SET 커맨드를 이용해 save 파라미터를 ""로 초기화
```redis
127.0.0.1:6379> CONFIG GET save
1) "save"
2) "3600 1 300 100 60 10000"

127.0.0.1:6379> CONFIG SET save ""
OK

127.0.0.1:6379> CONFIG GET save
1) "save"
2) ""

127.0.0.1:6379> CONFIG REWRITE
(error) ERR The server is running without a config file
```
- 실행 중인 레디스 인스턴스에서 파라미터를 수정할 때에는 redis-cli에서 직접 CONFIG SET 커맨드로 설정을 변경한 뒤, CONFIG REWRITE 커맨드를 이용해 설정 파일을 재작성하는 과정을 거쳐야 한다.
### 2. 수동으로 RDB 파일 생성
- SAVE, BGSAVE 커맨드를 이용하면 원하는 시점에 직접 RDB 파일을 생성할 수 있다. 두 커맨드 모두 실행 시점의 메모리 스냅숏을 생성하는 커맨드이지만 동작하는 방식에 차이가 있다. SAVE는 동기 방식으로 파일을 저장하므로 일반적인 운영 환경에서는 사용하지 않는 것이 좋다.
- BGSAVE는 fork를 호출해 자식 프로세스를 생ㅅ하며 생성된 자식 프로세스가 백그라운드에서 RDB 파일을 생성한 뒤 종료된다. 레디스를 이용하는 다른 클라이언트는 원래 부모 프로세스에서 처리되기에 파일 저장에 영향을 받지 않는다. 만약, 이미 백그라운드로 데이터가 저장되고 있을 때 이 커맨드를 수행하면 에러를 반환한다. 이때, SCHEDULE 옵션을 사용하면 기존에 진행 중이던 백업이 완료되었을 때 다시 BGSAVE를 실행한다.
- RDB 파일이 정상적으로 저장되었는지 LASTSAVE 커맨드로 확인할 수 있다.

### 3. 복제를 사용할 경우 자동으로 RDB 파일 생성
- REPLICAOF 커맨드를 이용해 복제를 요청하면 마스터 노드에서는 RDB 파일을 새로 생성해 복제본에 전달한다. 혹은 이미 복제 연결이 돼 있는 상태에서 네트워크 등의 이슈로 인해 일정 시간 이상 복제가 끊어졌다가 복구된 경우 복제 재연결이 발생하며, 이럴 경우에도 마스터 노드는 복제본으로 RDB 파일을 전송한다. 즉, 마스터에서는 언제든지 RDB 파일을 재생성할 수 있다.

## AOF 방식 데이터 백업
### 1. AOF 파일 재구성 방법
### 2. 자동 AOF 재구성
### 3. 수동 AOF 재구성
### 4. AOF 타임스탬프
### 5. AOF 파일 복원
### 6. AOF파일 안전성

## 백업 사용 시 주의점